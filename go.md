[TOC]

## 基础
### 文件类型
go程序生命周期中的三种文件，分为`可执行文件`、`归档文件`、`源码文件`(`命令源码文件`、`库源码文件`、`测试源码文件`)
- `归档文件` 实际上就是`静态链接库文件`，以`.a`结尾
- `命令源码文件` 作为可执行的程序的入口，拥有`main`函数
- `库源码文件` 不能被直接运行的源码文件，用于集中放置各种待被使用的程序实体(全局常量、全局变量、接口、结构体、函数等等)
- `测试源码文件` 用于对前两种源码文件中的程序实体的功能和性能进行测试`xx_test.go`

### 代码包
- GO源码以`代码包`为基本组织单位。`代码包`与系统目录一一对应。由于目录可以有子目录，所以`代码包`也可以有`子包`。
- 若包A依赖包B 则 B 是 A 的`依赖包`，A 是 B 的`触发包`
- `internal`内部引用目录:  `internal`目录下的包仅父级包可访问 ，祖先不可访问
- `$GOROOT/src/` 存放`官方包`的路径
- `$GOPATH/src/包名` 存放`第三方包`的路径

## 日志包设计
### 日志包应具备的功能
- 日志包要具备的功能可分为`基础`、`高级`、`可选`
- 设计日志包要关注的点 `高性能`、`并发安全`、`插件化能力`、`日志参数控制`、

#### 基础功能
- 支持基本日志信息 `时间戳`、`文件名`+`行号`(定位问题)、`级别`(过滤error)、`日志信息`
- 支持不同日志`级别`(由低至高) `trace`(可选的), `debug`, `info`, `warn`, `error`, `panic`(可选的), `fatal`
    + `输出级别` 如`glog.Info("xxx")`指输出级别为`info`
    + `开关级别` 启动应用程序时期望那些`输出级别`的日志被打印，如`开关级别 >= error`则仅记录`error`, `panic`, `fatal`
- 支持自定义配置 如根据不同环境设置不同日志级别，不同情况下输出不同的日志格式
- 支持输出到标准输出和文件

#### 高级功能
- 支持多种日志格式 `text` `json`
- 能按级别分类输出 如错误级别日志单独输出到文件
- 支持`structured logging`(结构化日志)
- 支持`日志轮转` 建议第三方工具实现，如在`Linux`中使用`Logrotate`来轮转日志
- 具备`hook`能力可对日志内容进行自定义处理，如`panic`级别出现时用邮件进行告警
    + 在一个大型系统中，日志告警是非常重要的功能，但更好的实现方式是将告警能力做成旁路功能。通过旁路功能，可以保证日志包功能聚焦、简洁。例如：可以将日志收集到 Elasticsearch，并通过 ElastAlert 进行日志告警。
    
#### 可选功能
- 支持颜色输出
- 兼容标准库log包
- 支持输出到不同位置 如`elasticsearch` `kafka` `fluentd` `logstash`
    + 也可以通过`filebeat`采集硬盘日志再进行投递
    

### 日志包的使用(如何记录日志)
#### 使用时机，哪种代码时嵌入
- 在分支语句处打印日志
- 写操作必须打印日志
- 循环中打印日志要慎重 循环打印会降低性能，建议循环中记录要点，循环外总结打印
- 错误产生的最原始位置打印日志，如error一层层上报时仅在最原始层打印错误日志

#### 设置`开关级别`
- `Debug`级别仅在开发调试阶段需要
- `Info`以满足需求为主要目标，不可频度过高(高频度可记录在Debug级别)
- `Warn`通常为`异常但不影响程序运行`的日志，常用于业务级别警告日志
- `Error`错误日志
- `Panic`很少使用，通常在错误堆栈或defer处理错误时使用
- `Fatal`严重错误，通常为系统级别错误，会导致程序无法运行

#### 日志内容
- 不要输出敏感信息 密码、密钥
- 应用Debug日志调试时可用`log.Debugf("XXXXXX-1: input key was: %s", setKeyName)`，调试完成后在找到这些临时日志并删掉。
- 日志内容应`小写字母开头 英文点号结尾`
- 输出时应用明确类型如`%s`而不是`%v`
- 日志应包含`requestID`,`uid`,`行为`

#### 最佳实践
- 支持requestID
- 根据故障排查过程优化日志打印
- 结构化日志记录，添加通用字段在每行日志中
- 支持动态日志输出，如在请求中通过debug=true开启debug日志

#### 分布式日志解决方案(EFK/ELK)
- ELK: Elasticsearch + Logstash + Kibana
- EFK: Elasticsearch + Filebeat + Kibana
- `Filebeat`比`Logstash`更轻量级

